!function(){"use strict";class t{constructor(t){this.target=t,this.lastElem=null}createInput(){const t=document.createElement("input");t.classList.add("input"),t.type="text",this.lastElem=t,t.addEventListener("keypress",this.target.onEnterTapeHandler),this.target.container.appendChild(t)}createMessage(t,e,i){const s=document.createElement("div"),n=document.createElement("div"),a=document.createElement("p"),o=document.createElement("time"),d=document.createElement("div");s.classList.add("message"),n.classList.add("message__body"),a.classList.add("message__body_text"),o.classList.add("message__body_time"),d.classList.add("message__coords"),o.textContent=new Date(Number(i)).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit",year:"numeric"}),d.textContent=`[${e.latitude}, ${e.longitude}]`,"string"==typeof t&&(a.textContent=t),n.appendChild(a),n.appendChild(o),s.appendChild(n),s.appendChild(d),this.target.container.insertBefore(s,this.lastElem)}createPopupError(){const t=document.createElement("div"),e=document.createElement("h2"),i=document.createElement("p"),s=document.createElement("div"),n=document.createElement("label"),a=document.createElement("input"),o=document.createElement("div"),d=document.createElement("button"),l=document.createElement("button");t.classList.add("popup"),e.classList.add("popup_title"),i.classList.add("popup_text"),n.classList.add("label"),a.classList.add("input"),o.classList.add("buttons"),l.classList.add("btn"),l.classList.add("btn-ok"),d.classList.add("btn"),d.classList.add("btn-close"),a.id="coords",a.type="text",a.setAttribute("novalidate",!0),n.setAttribute("for","coords"),a.setAttribute("required",!0),e.textContent="Что-то пошло не так",i.textContent="К сожалению нам не удалось определить Ваше местоположение. Пожалуйста, дайте разрешение на использование геолокации, либо введите данные вручную.",n.textContent="Широта и долгота через запятую",l.textContent="Ok",d.textContent="Отмена",l.addEventListener("click",this.target.onClick),d.addEventListener("click",this.target.onClick),s.appendChild(n),s.appendChild(a),o.appendChild(l),o.appendChild(d),t.appendChild(e),t.appendChild(i),t.appendChild(s),t.appendChild(o),this.target.container.appendChild(t)}createTooltip(t,e){const i=document.createElement("div");i.classList.add("tooltip-error"),i.textContent=t,document.body.appendChild(i);const{left:s,bottom:n}=e.getBoundingClientRect();i.style.top=n+5+"px",i.style.left=s+"px"}}class e{constructor(t){this.target=t,this.getGeolocation=this.getGeolocation.bind(this)}getGeolocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:i}=t.coords;this.target.position={latitude:e,longitude:i},this.target.processingDataMessage()}),(()=>{this.target.view.createPopupError()}),{enableHighAccuracy:!0})}}class i{constructor(t){this.target=t,this.safelyValidate=this.safelyValidate.bind(this),this.validate=this.validate.bind(this)}validate(t){if(!new RegExp("^[\\[]?[-+]?([1-8]?\\d(\\.\\d+)?|90(\\.0+)?),\\s*[-+]?(180(\\.0+)?|((1[0-7]\\d)|([1-9]?\\d))(\\.\\d+)?)[\\]]?$","m").test(t))throw new Error("Координаты введены не корректно");return!0}safelyValidate(t){try{this.validate(this.target.position);const e=this.target.position.split("").filter((t=>"["!==t&&"]"!==t&&" "!==t)).join("").split(","),i=e[0],s=e[1];this.target.position={latitude:i,longitude:s};const n=document.querySelector(".tooltip-error");n&&n.remove(),t.remove(),this.target.processingDataMessage()}catch(e){const i=t.querySelector(".input");this.target.view.createTooltip(e.message,i)}}}const s=document.querySelector(".root");new class{constructor(s){if(!(s instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=s,this.view=new t(this),this.geolocation=new e(this),this.validate=new i(this),this.position=null,this.message=null,this.onEnterTapeHandler=this.onEnterTapeHandler.bind(this),this.processingDataMessage=this.processingDataMessage.bind(this),this.onClick=this.onClick.bind(this)}init(){this.view.createInput()}onEnterTapeHandler(t){if(13===t.keyCode){const e=t.target;this.message=e.value,this.geolocation.getGeolocation(t)}}processingDataMessage(){const t=document.querySelector(".input");if(!this.message)return;const e=Date.now();this.view.createMessage(this.message,this.position,e),t.value=""}onClick(t){const e=t.target,i=e.closest(".popup");if(e.className.includes("close"))i.remove();else{const t=i.querySelector(".input");this.position=t.value.trim(),this.validate.safelyValidate(i)}}}(s).init()}();